<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–∞ 2048 - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è</title>
    <!-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç–æ–≥–æ CSS –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –∞–Ω–∏–º–∞—Ü–∏–π -->
    <style>
        /* === –ë–∞–∑–æ–≤—ã–π —Å–±—Ä–æ—Å –∏ —à—Ä–∏—Ñ—Ç—ã === */
        :root {
            --grid-size: 4;
            --cell-gap: 12px;
            --tile-transition-duration: 0.15s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #faf8ef;
            color: #776e65;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        /* === –®–∞–ø–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .title {
            font-size: 3rem;
            font-weight: 700;
            color: #776e65;
            margin: 0 0 10px 0;
        }

        .score-board {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-container {
            background: #bbada0;
            color: #eee4da;
            padding: 8px 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.2;
            min-width: 80px;
        }

        .score-container div {
            font-size: 0.7rem;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .control-btn {
            background-color: #8f7a66;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }

        .control-btn:hover {
            background-color: #776e65;
        }
        
        .control-btn:active {
            transform: scale(0.98);
        }

        /* === –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ (–°–µ—Ç–∫–∞) === */
        .game-board {
            position: relative;
            background: #bbada0;
            border-radius: 8px;
            padding: var(--cell-gap);
            width: 100%;
            aspect-ratio: 1 / 1; /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—é —Ñ–æ—Ä–º—É */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            touch-action: none; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ —Å–≤–∞–π–ø–∞–º–∏ */
        }

        .grid-cell-container {
            display: grid;
            grid-template-columns: repeat(var(--grid-size), 1fr);
            grid-template-rows: repeat(var(--grid-size), 1fr);
            gap: var(--cell-gap);
            width: 100%;
            height: 100%;
        }

        .grid-cell {
            background: rgba(238, 228, 218, 0.35);
            border-radius: 3px;
            aspect-ratio: 1 / 1;
        }

        /* === –ü–ª–∏—Ç–∫–∏ === */
        .tile-container {
            position: absolute;
            top: var(--cell-gap);
            left: var(--cell-gap);
            width: calc(100% - 2 * var(--cell-gap));
            height: calc(100% - 2 * var(--cell-gap));
        }

        .tile {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            /* –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ: –ø–ª–∏—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–Ω–∏–º–∞—Ç—å 1/4 —à–∏—Ä–∏–Ω—ã –º–∏–Ω—É—Å 3/4 –∑–∞–∑–æ—Ä–æ–≤ */
            width: calc((100% - (var(--grid-size) - 1) * var(--cell-gap)) / var(--grid-size));
            height: calc((100% - (var(--grid-size) - 1) * var(--cell-gap)) / var(--grid-size));
            border-radius: 3px;
            font-weight: 700;
            font-size: 2.2rem;
            transition: transform var(--tile-transition-duration) ease-out, 
                        opacity var(--tile-transition-duration) ease-out,
                        background-color 0.1s;
            line-height: 1;
            box-sizing: border-box; /* –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è "—Ä–∞—Å—Å—ã–ø–∞–Ω–∏—è" */
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        .tile.tile-new {
            animation: appear 0.2s ease-out;
        }

        @keyframes appear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–ª–∏—è–Ω–∏—è */
        .tile.tile-merged {
            animation: merge 0.2s ease-in-out;
        }

        @keyframes merge {
            0% { transform: scale(0.9); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* –¶–≤–µ—Ç–∞ –ø–ª–∏—Ç–æ–∫ */
        .tile-2 { background: #eee4da; color: #776e65; font-size: 2.2rem; }
        .tile-4 { background: #ede0c8; color: #776e65; font-size: 2.2rem; }
        .tile-8 { background: #f2b179; color: #f9f6f2; font-size: 2.2rem; }
        .tile-16 { background: #f59563; color: #f9f6f2; font-size: 2.2rem; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; font-size: 2.2rem; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; font-size: 2.2rem; }
        .tile-128 { background: #edcf72; color: #f9f6f2; font-size: 1.8rem; }
        .tile-256 { background: #edcc61; color: #f9f6f2; font-size: 1.8rem; }
        .tile-512 { background: #edc850; color: #f9f6f2; font-size: 1.8rem; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 1.4rem; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 1.4rem; box-shadow: 0 0 30px #edc22e; }
        /* –ü–ª–∏—Ç–∫–∏ –≤—ã—à–µ 2048 */
        .tile-4096 { background: #3c3a32; color: #f9f6f2; font-size: 1.4rem; }
        .tile-8192 { background: #1c1c1c; color: #f9f6f2; font-size: 1.4rem; }
        .tile-16384 { background: #000; color: #f9f6f2; font-size: 1.2rem; }


        /* === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–û–≤–µ—Ä–ª–µ–π) === */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(250, 248, 239, 0.85);
            display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(3px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        .overlay-content {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            overflow-y: auto; /* –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –ª–∏–¥–µ—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            max-height: 90vh;
        }

        .overlay.active {
            display: flex;
            opacity: 1;
        }

        .overlay.active .overlay-content {
            opacity: 1;
            transform: translateY(0);
        }

        .overlay h2 {
            font-size: 2rem;
            margin-top: 0;
            color: #776e65;
        }
        
        .overlay p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .score-submit-form input[type="text"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 20px 0 0 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            overflow-y: auto;
            text-align: left;
        }

        .leaderboard-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
        }
        
        .leaderboard-list li:first-child {
            font-weight: bold;
            background-color: #f5f5f5;
        }
        
        .leaderboard-list li:nth-child(2) {
            background-color: #fff9e6; /* –ó–æ–ª–æ—Ç–æ –¥–ª—è 1 –º–µ—Å—Ç–∞ */
        }

        .leaderboard-list li:last-child {
            border-bottom: none;
        }
        
        .leaderboard-list li .date {
            font-size: 0.8rem;
            color: #aaa;
            margin-left: 10px;
        }

        /* === –ú–æ–±–∏–ª—å–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (D-pad) === */
        /* –ò–∑–º–µ–Ω–µ–Ω–æ: —Ç–µ–ø–µ—Ä—å display: block –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        .mobile-controls-container {
            display: block; 
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            margin-left: auto; 
            margin-right: auto;
        }

        .mobile-dpad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 5px;
        }
        
        .mobile-dpad .control-btn {
            width: 100%;
            height: 50px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .mobile-dpad .up-btn { grid-area: 1 / 2 / 2 / 3; }
        .mobile-dpad .left-btn { grid-area: 2 / 1 / 3 / 2; }
        .mobile-dpad .right-btn { grid-area: 2 / 3 / 3 / 4; }
        .mobile-dpad .down-btn { grid-area: 3 / 2 / 4 / 3; }
        .mobile-dpad .spacer { grid-area: 2 / 2 / 3 / 3; }


        /*  –ú–µ–¥–∏–∞–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .title { font-size: 2.2rem; }
            .score-container { padding: 5px 8px; font-size: 0.9rem; min-width: 60px; }
            .score-container div { font-size: 0.6rem; }
            .controls { gap: 5px; }
            .control-btn { padding: 8px 10px; font-size: 0.8rem; }
            
            /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç—ã –ø–ª–∏—Ç–æ–∫ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
            .tile { font-size: 1.6rem; }
            .tile-128, .tile-256, .tile-512 { font-size: 1.4rem; }
            .tile-1024, .tile-2048, .tile-4096, .tile-8192 { font-size: 1rem; }

            .header { 
                flex-direction: column; 
                align-items: center; 
                text-align: center;
            }
            .header-right { 
                width: 100%; 
                display: flex; 
                flex-direction: column; 
                align-items: center;
            }
            .score-board, .controls { justify-content: center; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <h1 class="title">2048</h1>
            <div class="header-right">
                <div class="score-board">
                    <div id="score-container" class="score-container">
                        <span id="score">0</span>
                        <div>–û—á–∫–∏</div>
                    </div>
                    <div id="best-score-container" class="score-container">
                        <span id="best-score">0</span>
                        <div>–†–µ–∫–æ—Ä–¥</div>
                    </div>
                </div>
                <div class="controls">
                    <button id="undo-btn" class="control-btn" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ö–æ–¥">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</button>
                    <button id="new-game-btn" class="control-btn" title="–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                    <button id="leaderboard-btn" class="control-btn" title="–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤">üèÜ –õ–∏–¥–µ—Ä—ã</button>
                </div>
            </div>
        </header>

        <main class="game-board">
            <div id="grid-cell-container" class="grid-cell-container">
                <!-- –Ø—á–µ–π–∫–∏ —Å–µ—Ç–∫–∏ (4x4) –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã JS -->
            </div>
            <div id="tile-container" class="tile-container">
                <!-- –ü–ª–∏—Ç–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ JS -->
            </div>
        </main>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (D-Pad) - –¢–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º -->
        <div id="mobile-controls-container" class="mobile-controls-container">
            <div class="mobile-dpad">
                <button class="control-btn up-btn" data-move="up">‚¨ÜÔ∏è</button>
                <button class="control-btn left-btn" data-move="left">‚¨ÖÔ∏è</button>
                <div class="spacer"></div>
                <button class="control-btn right-btn" data-move="right">‚û°Ô∏è</button>
                <button class="control-btn down-btn" data-move="down">‚¨áÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Game Over –∏ Leaderboard -->
    <div id="overlay" class="overlay">
        <div id="overlay-content" class="overlay-content">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ JS -->
        </div>
    </div>

    <script>
    // === JavaScript –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã 2048 ===

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const GRID_SIZE = 4;
    const WIN_TILE = 2048;
    const LEADERBOARD_KEY = '2048Leaderboard';
    const GAME_STATE_KEY = '2048GameState';
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const tileContainer = document.getElementById('tile-container');
    const scoreElement = document.getElementById('score');
    const bestScoreElement = document.getElementById('best-score');
    const overlay = document.getElementById('overlay');
    const overlayContent = document.getElementById('overlay-content');
    const undoBtn = document.getElementById('undo-btn');
    const mobileControls = document.getElementById('mobile-controls-container'); 
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ (–±—É–¥—É—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è)
    let tileWidth = 0;
    let tileGap = 0;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let grid = [];
    let score = 0;
    let bestScore = 0;
    let isGameOver = false;
    let isGameWon = false;
    let history = []; 
    const MAX_HISTORY = 10;
    let tileIdCounter = 0;
    let isMoving = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ö–æ–¥–æ–≤ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏

    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Å–≤–∞–π–ø–æ–≤
    let touchStartX = 0;
    let touchStartY = 0;
    const SWIPE_THRESHOLD = 50;

    // === 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ó–∞–≥—Ä—É–∑–∫–∞ –°–æ—Å—Ç–æ—è–Ω–∏—è ===

    /** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Å—Ç—É—é —Å–µ—Ç–∫—É. */
    function initializeGrid() {
        grid = Array(GRID_SIZE).fill(0).map(() => 
            Array(GRID_SIZE).fill(0).map(() => ({ value: 0, id: null }))
        );
        tileIdCounter = 0;
    }

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∫–æ—Ä–¥—ã –∏–∑ localStorage. */
    function loadLeaderboard() {
        const lb = localStorage.getItem(LEADERBOARD_KEY);
        return lb ? JSON.parse(lb) : [];
    }

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∏–∑ localStorage. */
    function loadState() {
        const state = localStorage.getItem(GAME_STATE_KEY);
        if (state) {
            const savedState = JSON.parse(state);
            grid = savedState.grid;
            score = savedState.score;
            bestScore = savedState.bestScore;
            history = savedState.history;
            tileIdCounter = savedState.tileIdCounter;
            isGameOver = savedState.isGameOver;
            isGameWon = savedState.isGameWon;
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
            bestScore = loadLeaderboard().reduce((max, entry) => Math.max(max, entry.score), 0);
            newGame(false); // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
        }
    }

    /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –≤ localStorage. */
    function saveState() {
        bestScore = Math.max(bestScore, score);
        localStorage.setItem(GAME_STATE_KEY, JSON.stringify({
            grid,
            score,
            bestScore,
            history,
            tileIdCounter,
            isGameOver,
            isGameWon
        }));
    }

    /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é —Å–µ—Ç–∫—É, —Å—á–µ—Ç –∏ —Å—á–µ—Ç—á–∏–∫ ID –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ö–æ–¥–∞. */
    function pushHistory() {
        if (isGameOver || isMoving) return;
        
        // –ì–ª—É–±–æ–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∫–∏
        const gridCopy = grid.map(row => 
            row.map(cell => ({ ...cell }))
        );

        history.push({ 
            grid: gridCopy, 
            score: score,
            tileIdCounter: tileIdCounter
        });

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        if (history.length > MAX_HISTORY) {
            history.shift(); 
        }
    }

    /** –û—Ç–º–µ–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ö–æ–¥. */
    function undoMove() {
        if (history.length > 0 && !isMoving) {
            const lastState = history.pop();
            grid = lastState.grid;
            score = lastState.score;
            tileIdCounter = lastState.tileIdCounter; 
            
            isGameOver = false;
            isGameWon = false;
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–∏—Ç–æ–∫ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            while (tileContainer.firstChild) {
                tileContainer.removeChild(tileContainer.firstChild);
            }
            
            saveState();
            renderGame();
        } else if (!isMoving) {
            showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ö–æ–¥–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã.', true);
        }
        updateControls();
    }
    
    // === 2. –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã ===

    /** –ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É. */
    function newGame(save = true) {
        initializeGrid();
        score = 0;
        isGameOver = false;
        isGameWon = false;
        history = [];
        
        // –°–ø–∞–≤–Ω–∏–º 2-3 –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–ª–∏—Ç–∫–∏
        spawnRandomTile();
        spawnRandomTile();
        spawnRandomTile(); 
        
        // –ü–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        pushHistory();
        if (save) saveState();
        
        overlay.classList.remove('active');
        
        renderGame();
        updateControls();
    }

    /** –ò—â–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–ª–∏—Ç–∫—É 2 –∏–ª–∏ 4. */
    function spawnRandomTile() {
        const emptyCells = [];
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (grid[r][c].value === 0) {
                    emptyCells.push({ r, c });
                }
            }
        }

        if (emptyCells.length > 0) {
            const { r, c } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            const value = Math.random() < 0.9 ? 2 : 4;
            grid[r][c] = { value: value, id: ++tileIdCounter };
            return true;
        }
        return false;
    }

    /** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ —Å–æ–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥. */
    function hasMoves() {
        if (grid.some(row => row.some(cell => cell.value === 0))) {
            return true; // –ï—Å—Ç—å –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–ª–∏—è–Ω–∏—è –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                const current = grid[r][c].value;
                if (c < GRID_SIZE - 1 && current === grid[r][c + 1].value) return true; // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
                if (r < GRID_SIZE - 1 && current === grid[r + 1][c].value) return true; // –í–µ—Ä—Ç–∏–∫–∞–ª—å
            }
        }

        return false;
    }

    /** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –ø–æ–±–µ–¥—ã. */
    function checkWin() {
        if (isGameWon) return; 
        if (grid.some(row => row.some(cell => cell.value >= WIN_TILE))) {
            isGameWon = true;
            showGameOver(true);
        }
    }

    /** –ó–∞–ø—É—Å–∫–∞–µ—Ç –ª–æ–≥–∏–∫—É –¥–≤–∏–∂–µ–Ω–∏—è. */
    function move(direction) {
        if (isGameOver || isMoving || isGameWon) return;
        isMoving = true;
        
        pushHistory(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ö–æ–¥–∞
        let moved = false;
        let pointsGained = 0;
        
        let rotatedGrid = grid;
        if (direction === 'up') {
            rotatedGrid = rotateGrid(grid, 3);
        } else if (direction === 'down') {
            rotatedGrid = rotateGrid(grid, 1);
        } else if (direction === 'right') {
            rotatedGrid = rotateGrid(grid, 2);
        }

        for (let r = 0; r < GRID_SIZE; r++) {
            const { newRow, rowMoved, rowPoints } = slideAndMerge(rotatedGrid[r]);
            
            rotatedGrid[r] = newRow;
            
            if (rowMoved) moved = true;
            pointsGained += rowPoints;
        }

        if (direction === 'up') {
            grid = rotateGrid(rotatedGrid, 1);
        } else if (direction === 'down') {
            grid = rotateGrid(rotatedGrid, 3);
        } else if (direction === 'right') {
            grid = rotateGrid(rotatedGrid, 2);
        } else {
            grid = rotatedGrid;
        }
        
        score += pointsGained;

        if (moved) {
            spawnRandomTile();
            checkWin();
            
            // –†–µ–Ω–¥–µ—Ä–∏–º, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            renderGame();
            setTimeout(() => {
                saveState();
                isMoving = false;
                
                if (!hasMoves()) {
                    isGameOver = true;
                    showGameOver();
                }
            }, 150); 
            
        } else {
            // –ï—Å–ª–∏ —Ö–æ–¥ –Ω–µ —Å–æ–≤–µ—Ä—à–∏–ª—Å—è, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            history.pop();
            isMoving = false;
            if (!hasMoves()) {
                isGameOver = true;
                showGameOver();
            }
        }
        
        updateControls();
    }
    
    /** –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É/—Å—Ç–æ–ª–±–µ—Ü. */
    function slideAndMerge(row) {
        let rowMoved = false;
        let rowPoints = 0;
        
        let activeCells = row.filter(cell => cell.value !== 0);
        const initialValues = row.map(cell => cell.value);
        
        for (let i = 0; i < activeCells.length - 1; i++) {
            if (activeCells[i].value === activeCells[i + 1].value) {
                const mergedValue = activeCells[i].value * 2;
                rowPoints += mergedValue;
                
                activeCells[i].value = mergedValue;
                activeCells[i].merged = true; // –§–ª–∞–≥ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                
                activeCells.splice(i + 1, 1); 
            }
        }
        
        while (activeCells.length < GRID_SIZE) {
            activeCells.push({ value: 0, id: null });
        }
        
        const finalValues = activeCells.map(cell => cell.value);
        for (let i = 0; i < GRID_SIZE; i++) {
            if (initialValues[i] !== finalValues[i]) {
                rowMoved = true;
                break;
            }
        }

        return { newRow: activeCells, rowMoved, rowPoints };
    }
    
    /** –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Å–µ—Ç–∫—É –Ω–∞ 90 –≥—Ä–∞–¥—É—Å–æ–≤ –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ (times=1). */
    function rotateGrid(currentGrid, times) {
        let newGrid = currentGrid.map(row => row.map(cell => ({ ...cell })));

        for (let t = 0; t < times % 4; t++) {
            let tempGrid = Array(GRID_SIZE).fill(0).map(() => 
                Array(GRID_SIZE).fill(0).map(() => ({ value: 0, id: null }))
            );
            
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    tempGrid[c][GRID_SIZE - 1 - r] = newGrid[r][c];
                }
            }
            newGrid = tempGrid;
        }
        return newGrid;
    }


    // === 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DOM –∏ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å) ===

    /** –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–ª–∏—Ç–æ–∫ –∏ –∑–∞–∑–æ—Ä–æ–≤. */
    function calculateDimensions() {
        // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∑–æ—Ä–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        const gapStyle = getComputedStyle(document.documentElement).getPropertyValue('--cell-gap');
        tileGap = parseFloat(gapStyle) || 12; 
        
        // –ü–æ–ª—É—á–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –æ–±–ª–∞—Å—Ç–∏ —Å–µ—Ç–∫–∏)
        const containerWidth = tileContainer.clientWidth; 
        
        // –û–±—â–∞—è —à–∏—Ä–∏–Ω–∞, –∑–∞–Ω–∏–º–∞–µ–º–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –∑–∞–∑–æ—Ä–∞–º–∏ (GRID_SIZE - 1)
        const totalGapSpace = (GRID_SIZE - 1) * tileGap; 
        
        // –®–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–π –ø–ª–∏—Ç–∫–∏
        tileWidth = (containerWidth - totalGapSpace) / GRID_SIZE;
        
        // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
        if (tileWidth > 0) {
            updateTilesPositioning();
        }
    }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–ª–∏—Ç–æ–∫. */
    function updateTilesPositioning() {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        if (isMoving) return; 

        // –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –ø–ª–∏—Ç–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ DOM
        const tiles = Array.from(tileContainer.children);

        tiles.forEach(tile => {
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (r, c) –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö –≤–æ –≤—Ä–µ–º—è —Ö–æ–¥–∞
            const r = parseInt(tile.dataset.r);
            const c = parseInt(tile.dataset.c);
            
            // –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏
            const xPos = c * (tileWidth + tileGap);
            const yPos = r * (tileWidth + tileGap);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
            tile.style.transform = `translate(${xPos}px, ${yPos}px)`;
        });
    }

    /** –†–µ–Ω–¥–µ—Ä–∏—Ç –≤—Å—é –∏–≥—Ä—É (—Å–µ—Ç–∫—É, –ø–ª–∏—Ç–∫–∏, —Å—á–µ—Ç). */
    function renderGame() {
        updateScore();
        updateTiles();
    }
    
    /** –°–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ —è—á–µ–π–∫–∏ —Å–µ—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–æ–Ω–∞). */
    function createGridCells() {
        const gridContainer = document.getElementById('grid-cell-container');
        while (gridContainer.firstChild) {
            gridContainer.removeChild(gridContainer.firstChild);
        }
        for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            gridContainer.appendChild(cell);
        }
    }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç –∏ —Ä–µ–∫–æ—Ä–¥. */
    function updateScore() {
        scoreElement.textContent = score;
        bestScoreElement.textContent = bestScore;
    }
    
    /** –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –û—Ç–º–µ–Ω–∞). */
    function updateControls() {
        undoBtn.disabled = history.length === 0 || isMoving;
    }

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–ª–∏—Ç–∫–∏ –Ω–∞ –¥–æ—Å–∫–µ. */
    function updateTiles() {
        // 1. –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏
        calculateDimensions(); 
        
        const oldTiles = Array.from(tileContainer.children);
        const newTiles = [];
        
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                const cell = grid[r][c];
                if (cell.value > 0) {
                    
                    let tile = document.getElementById(`tile-${cell.id}`);
                    const isNew = !tile;
                    
                    if (isNew) {
                        tile = document.createElement('div');
                        tile.id = `tile-${cell.id}`;
                        tile.className = 'tile tile-new';
                        tile.textContent = cell.value;
                        tile.style.zIndex = 10;
                    } else {
                        tile.classList.remove('tile-new');
                        if (cell.merged) {
                            tile.classList.add('tile-merged');
                            cell.merged = false;
                            tile.textContent = cell.value; 
                        } else {
                            tile.classList.remove('tile-merged');
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ü–≤–µ—Ç–∞
                    tile.className = tile.className.split(' ').filter(cls => !cls.startsWith('tile-')).join(' ');
                    tile.classList.add(`tile-${cell.value}`);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ data-–∞—Ç—Ä–∏–±—É—Ç–∞—Ö –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
                    tile.dataset.r = r;
                    tile.dataset.c = c;
                    
                    // –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏
                    const xPos = c * (tileWidth + tileGap);
                    const yPos = r * (tileWidth + tileGap);
                    tile.style.transform = `translate(${xPos}px, ${yPos}px)`;

                    if (isNew) {
                        tileContainer.appendChild(tile);
                    }
                    newTiles.push(tile);
                }
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–ª–∏—Ç–æ–∫
        oldTiles.forEach(oldTile => {
            if (!newTiles.includes(oldTile)) {
                oldTile.style.opacity = '0';
                oldTile.style.zIndex = '1';
                setTimeout(() => {
                    oldTile.remove();
                }, 150); 
            }
        });
    }


    // === 4. Game Over –∏ Leaderboard ===

    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã. */
    function showGameOver(isWin = false) {
        if (!isGameOver && !isWin) return;
        
        isGameOver = true;
        mobileControls.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º d-pad –ø—Ä–∏ –æ–≤–µ—Ä–ª–µ–µ
        
        let title = isWin ? '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!' : '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!';
        let message = isWin ? `–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–ª–∏—Ç–∫–∏ ${WIN_TILE}! –í–∞—à —Å—á–µ—Ç: ${score}` : `–•–æ–¥–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç. –í–∞—à —Å—á–µ—Ç: ${score}`;
        let contentHtml = `
            <h2>${title}</h2>
            <p>${message}</p>
            <div id="score-submit-area">
                <form id="score-submit-form">
                    <input type="text" id="player-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required maxlength="15">
                    <button type="submit" id="save-score-btn" class="control-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                </form>
            </div>
            <button id="restart-from-gameover" class="control-btn" style="margin-top: 15px;">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        `;
        
        while (overlayContent.firstChild) {
            overlayContent.removeChild(overlayContent.firstChild);
        }
        overlayContent.insertAdjacentHTML('afterbegin', contentHtml);
        overlay.classList.add('active');

        document.getElementById('restart-from-gameover').addEventListener('click', newGame);
        
        const submitForm = document.getElementById('score-submit-form');
        if (submitForm) {
            submitForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('player-name-input');
                saveScore(nameInput.value, score);
                
                
                const submitArea = document.getElementById('score-submit-area');
                
                // 1. –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (—É–¥–∞–ª—è–µ–º —Ñ–æ—Ä–º—É)
                while (submitArea.firstChild) {
                    submitArea.removeChild(submitArea.firstChild);
                }

                // 2. –°–æ–∑–¥–∞–µ–º –∏ —Å—Ç–∏–ª–∏–∑—É–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç P
                const confirmationMessage = document.createElement('p');
                confirmationMessage.textContent = '–í–∞—à —Ä–µ–∫–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!';
                confirmationMessage.style.color = '#4CAF50'; 
                confirmationMessage.style.fontWeight = 'bold';
                confirmationMessage.style.fontSize = '1.1rem'; // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
                
                // 3. –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
                submitArea.appendChild(confirmationMessage);
                
            });
        }
    }

    /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤. */
    function saveScore(name, finalScore) {
        const leaderboard = loadLeaderboard();
        const newEntry = {
            name: name.trim() || '–ê–Ω–æ–Ω–∏–º',
            score: finalScore,
            date: new Date().toLocaleDateString('ru-RU')
        };

        leaderboard.push(newEntry);
        leaderboard.sort((a, b) => b.score - a.score);
        
        const top10 = leaderboard.slice(0, 10);

        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(top10));
        
        bestScore = top10.length > 0 ? top10[0].score : 0;
        updateScore();
        saveState();
    }

    /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤. */
    function showLeaderboard() {
        mobileControls.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º d-pad –ø—Ä–∏ –æ–≤–µ—Ä–ª–µ–µ
        
        const leaderboard = loadLeaderboard();
        let listHtml = leaderboard.length > 0 ? 
            leaderboard.map((entry, index) => 
                `<li>
                    <span>${index + 1}. ${entry.name}</span>
                    <span>${entry.score} <span class="date">(${entry.date})</span></span>
                </li>`
            ).join('') : 
            '<li>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤.</li>';

        let contentHtml = `
            <h2>üèÜ –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ (–¢–û–ü-10)</h2>
            <ul class="leaderboard-list">
                <li><span>–ò–º—è</span><span>–û—á–∫–∏</span></span></li>
                ${listHtml}
            </ul>
            <button id="close-leaderboard" class="control-btn" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        `;

        while (overlayContent.firstChild) {
            overlayContent.removeChild(overlayContent.firstChild);
        }
        overlayContent.insertAdjacentHTML('afterbegin', contentHtml);
        overlay.classList.add('active');

        document.getElementById('close-leaderboard').addEventListener('click', () => {
            overlay.classList.remove('active');
            // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–≤–µ—Ä–ª–µ—è, –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –æ–∫–æ–Ω—á–µ–Ω–∞, d-pad —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–Ω–æ–≤–∞ –≤–∏–¥–µ–Ω (—á–µ—Ä–µ–∑ CSS)
            if (!isGameOver && !isGameWon) {
                mobileControls.style.display = 'block'; 
            }
        });
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π "alert" (showNotification)
    function showNotification(message, isError = false) {
        let notification = document.getElementById('custom-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'custom-notification';
            // –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const style = `
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
                padding: 10px 20px; border-radius: 5px; color: white; z-index: 1000; 
                opacity: 0; transition: opacity 0.3s; font-weight: 600;
            `;
            notification.style.cssText = style;
            document.body.appendChild(notification);
        }

        notification.textContent = message;
        notification.style.backgroundColor = isError ? '#f44336' : '#4CAF50';
       
        notification.style.opacity = '1';

        clearTimeout(notification.timer);
        notification.timer = setTimeout(() => {
            notification.style.opacity = '0';
        }, 3000);
    }

    // === 5. –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π ===
    
    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à. */
    function handleKeyDown(e) {
        if (overlay.classList.contains('active')) return;
        
        const keyMap = {
            'ArrowUp': 'up',
            'ArrowDown': 'down',
            'ArrowLeft': 'left',
            'ArrowRight': 'right',
            'w': 'up',
            's': 'down',
            'a': 'left',
            'd': 'right'
        };
        
        if (keyMap[e.key.toLowerCase()]) {
            e.preventDefault();
            move(keyMap[e.key.toLowerCase()]);
        }
    }
    
    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª–æ —Å–≤–∞–π–ø–∞. */
    function handleTouchStart(e) {
        if (isGameOver || isGameWon || isMoving) return;
        if (e.touches.length === 1) { 
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
    }

    /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω–µ—Ü —Å–≤–∞–π–ø–∞. */
    function handleTouchEnd(e) {
        if (isGameOver || isGameWon || isMoving || e.changedTouches.length !== 1) return;
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        
        const absDeltaX = Math.abs(deltaX);
        const absDeltaY = Math.abs(deltaY);

        if (absDeltaX > SWIPE_THRESHOLD || absDeltaY > SWIPE_THRESHOLD) {
            let direction = '';
            
            if (absDeltaX > absDeltaY) {
                direction = deltaX > 0 ? 'right' : 'left';
            } else {
                direction = deltaY > 0 ? 'down' : 'up';
            }
            
            if (direction) {
                 e.preventDefault(); 
                 move(direction);
            }
        }
    }
    
    /** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤—Å–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π. */
    function setupEventListeners() {
        document.addEventListener('keydown', handleKeyDown);
        
        const gameBoard = document.querySelector('.game-board');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º passive: false –¥–ª—è —Å–≤–∞–π–ø–æ–≤, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É
        gameBoard.addEventListener('touchstart', handleTouchStart, { passive: false });
        gameBoard.addEventListener('touchend', handleTouchEnd, { passive: false });
        
        document.getElementById('new-game-btn').addEventListener('click', newGame);
        document.getElementById('undo-btn').addEventListener('click', undoMove);
        document.getElementById('leaderboard-btn').addEventListener('click', showLeaderboard);

        document.getElementById('mobile-controls-container').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-move]');
            if (btn) {
                move(btn.getAttribute('data-move'));
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ (–¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏)
        window.addEventListener('resize', () => {
            // –ó–∞–¥–µ—Ä–∂–∫–∞ (debounce) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö –ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç–æ–≤
            if (typeof window.resizeTimer !== 'undefined') clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => {
                calculateDimensions();
            }, 100); 
        });
    }

    // === 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ===

    document.addEventListener('DOMContentLoaded', () => {
        createGridCells();
        setupEventListeners();
        loadState();
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
        calculateDimensions();
        renderGame();
        
        if (isGameOver || isGameWon) {
            showGameOver(isGameWon);
        }
    });

    </script>
</body>
</html>
